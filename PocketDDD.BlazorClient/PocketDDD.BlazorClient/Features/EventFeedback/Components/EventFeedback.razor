@using PocketDDD.BlazorClient.Features.EventFeedback.Store
@using Microsoft.AspNetCore.Components
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@inject IState<EventFeedbackState> State
@inject IDispatcher Dispatcher

<MudDialog>
    <TitleContent><MudText Typo="Typo.h6" Align="Align.Center">Event Feedback</MudText></TitleContent>
    <DialogContent>

        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h5">Please provide feedback on the event</MudText>
                <MudText Typo="Typo.body2" Class="mt-2">
                    You will get 3 prize draw entries for providing event feedback.<br/>
                    Note: You are welcome to update your feedback, but it won't get you any extra points!
                </MudText>
            </MudCardContent>
        </MudCard>

        <MudCard Class="mt-3">
            <MudCardContent>
                <MudText Typo="Typo.h6">Refreshments:</MudText>
                <MudRating SelectedValue="@_refreshments" SelectedValueChanged="newValue => { _refreshments = newValue; HandleDataChanged();}" />
                
                <MudText Typo="Typo.h6">Venue:</MudText>
                <MudRating SelectedValue="@_venue" SelectedValueChanged="newValue => { _venue = newValue; HandleDataChanged();}" />
                
                <MudText Typo="Typo.h6">Overall:</MudText>
                <MudRating SelectedValue="@_overall" SelectedValueChanged="newValue => { _overall = newValue; HandleDataChanged();}" />

                <MudText Typo="Typo.h6">Comments:</MudText>
                <MudText Typo="Typo.body2">
                    <MudTextField Value="_comments" ValueChanged="(string newText) => { _comments = newText; HandleDataChanged();}"
                        Immediate="true"
                        Variant="Variant.Text"
                        Lines="3">
                    </MudTextField>
                </MudText>
            </MudCardContent>
        </MudCard>
    </DialogContent>
    <DialogActions>
        <MudButton 
            Variant="Variant.Filled"
            Color="Color.Secondary"
            FullWidth="true"
            OnClick="HandleCancel">
            Cancel
        </MudButton>
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Primary"
            FullWidth="true"
            OnClick="HandleSubmit"
            Disabled="!isDirty">
            Submit
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    int _refreshments = 0;
    int _venue = 0;
    int _overall = 0;
    string _comments = string.Empty;

    bool isDirty = false;

    protected override void OnParametersSet()
    {
        //_refreshments = State.Value.
        base.OnParametersSet();
    }

    void HandleDataChanged() => isDirty = true;

    void HandleSubmit()
    {
        Dispatcher.Dispatch(new SubmitEventFeedback(_refreshments, _venue, _overall, _comments));

        MudDialog.Close(DialogResult.Ok(true));
    }

    void HandleCancel()
    {
        MudDialog.Cancel();
    }
}
